$context.setCacheDuration(0)
#set($space_blogName = '')
#if("$!renderDocument" != '')
  #set($blogDoc = $renderDocument)
#end
#if("$!pageDoc.documentReference" != '')
  #set($theDoc = $xwiki.getDocument($pageDoc.documentReference))
#elseif("$!celldoc" != '')
  #set($theDoc = $celldoc)
#else
  #set($theDoc = $doc)
#end
#if("$!blogDoc" ==  '')
  #set($blogDoc = $theDoc)
#end
#set($isarchive = (("$request.get('archive')" == '1') || ("$cel_redParams_Map.get('archive')" == '1')))
#set($subscribable = "$!request.get('subscribable')" == '1')
#set($newSubscribable = "$!request.get('newSubscribable')" == '1')

##render blog title
#if("$!blogTitle" == '')
  #if($isarchive)
    #set($titleDoc = $theDoc)
  #else
    #set($titleDoc = $blogDoc)
  #end
  #if("$!titleDoc.getTitle()" == '')
    #set($blogTitle = "$!titleDoc.getObject('Content.Title').getProperty('title').getValue()")
  #else
    #set($blogTitle = "$!titleDoc.getTitle()")
  #end
#end
#if("$!supressBlogTitle" == '')
  #set($supressBlogTitle = !$celementsweb.getPageType($blogDoc.fullName).hasPageTitle())
#end
#if("$!showArticleBlogName" == '')
  #set($showArticleBlogName = false)
#end

#set($blogConfig_obj = $!blogDoc.getObject('Celements2.BlogConfigClass'))
#if("$!blogConfig_obj" != '')
  #set($spacename = "$!blogConfig_obj.getProperty('blogspace').getValue()")
#end
#if("$!spacename" == '')
  #set($spacename = "$!blogDoc.space")
#end
#set($blog_template = "$!blogConfig_obj.getProperty('template').getValue()")
#if("$!blog_template" == '')
  #set($blog_template = 'BlogTemplates.ArticleClassTemplate')
#end

##
#set ($sql = " where")
#set ($sql = "${sql} (doc.space = '$spacename'")
#foreach($subscSpace in $subscriptions) 
  #if("$!subscSpace" != '')
    #set ($sql = "${sql} or doc.space='$subscSpace'")
  #end
#end
#set ($sql = "${sql}) order by doc.date desc")
#set($mostRecentChangedArticle = $xwiki.searchDocuments($sql, 1, 0))
#if($mostRecentChangedArticle.size() > 0)
  #set($lastChanged = $xwiki.getDocument($mostRecentChangedArticle.get(0)).getDate()) 
#else
  #set($lastChanged = $blogDoc) 
#end
#set($reqIfModifiedSince = $request.getDateHeader("If-Modified-Since"))
#set($If_Modified_Since = ($lastChanged.getTime() == $reqIfModifiedSince))
#set($If_Not_loggedIn = ($context.getUser() == "XWiki.XWikiGuest"))
#if($If_Not_loggedIn && $If_Modified_Since)
$response.setStatus(304)
$context.setFinished(true)
#else
#if($If_Not_loggedIn)
  $response.setDateHeader("Last-Modified", $lastChanged.getTime())
#end
#if("$!request.xpage" == 'rdf')
## RSS mode
  #set($doc_name = "$!blogTitle")
  #set($title = $!xwiki.getSpacePreference("title"))
  #if ("$title" != '')
    #set($title = "$xwiki.parseContent($title) $!{doc_name}")
  #else
    #set($title = "$!{doc_name}")
  #end
  #set($blogSpace = $spacename)
  #set ($baseurl =  "http://${request.serverName}")
  #set($maxItems = 20)
  #parse('celMacros/BlogRssCode.vm')
#else
## normal (XHTML) mode
#set($viewtype = "$!blogConfig_obj.getProperty('viewtype').getValue()")
#if("$!viewtype" == '')
  #set($viewtype = 'extract')
#end
#set($has_comments = "$!blogConfig_obj.getProperty('has_comments').getValue()") 
#if("$!has_comments" == '1')
  #set($has_comments = true)
#else
  #set($has_comments = false)
#end

## TODO paging
#set($artPerPage = "$!blogConfig_obj.getProperty('art_per_page').getValue()")
#if("$!artPerPage" != '')
  #set($maxItems = $xwiki.parseInt($artPerPage))
#end

#if($isarchive)
  #set($articleParam = $services.celblog.getArchiveArticleLoadParameter())
#elseif($subscribable)
  #set($articleParam = $services.celblog.getSubsribedArticleLoadParameter())
#elseif($newSubscribable)
  #set($articleParam = $services.celblog.getUndecidedArticleLoadParameter())
#else
  #set($articleParam = $services.celblog.getDefaultArticleLoadParameter())
#end
#set($devNull = $articleParam.setLanguage("$default_language"))
#set($articles = $services.celblog.getArticles($blogConfDocRef, $articleParam))
#if("$!maxItems" != '') ##TODO remove after paging added
  #set($articles = $articles.subList(0, $mathtool.min($articles.size(), $maxItems)))
#end

##move to RLS
#if($blogDoc.hasAccessLevel("edit"))
  #set($allArticles = $blogApi.getAllWithRightsArticles("$spacename", "$space_blogName", "$default_language"))
  #if("$!request.get('newSubscribable')" != 1)
    #set($undecidedArticles = $blogApi.containsUndecidedArticles($allArticles, "$spacename"))
    #if($undecidedArticles == 1)
      ## write warning 
      <div class="newSubscribableArticleWarning">
        $adminMsg.get('rls_newSubscribableArticleWarning')
        <a href="?newSubscribable=1">$adminMsg.get('rls_newSubscribableArticleViewLink')</a>
      </div>
    #elseif($undecidedArticles > 1)
      ## write warning 
      <div class="newSubscribableArticleWarning">
        $adminMsg.get('rls_newSubscribableArticlesWarning', ["$!undecidedArticles"])
        <a href="?newSubscribable=1">$adminMsg.get('rls_newSubscribableArticlesViewLink')</a>
      </div>
    #end
  #end
  #if("$!request.get('subscribable')" != '1')
    #set($subscribableArticles = $blogApi.containsSubscribableArticles($allArticles, "$spacename"))
    #if($subscribableArticles > 0)
      $adminMsg.get('rls_showAllSubscribable', ["$!blogPageName"]) <a href="?subscribable=1">$adminMsg.get('rls_showAllSubscribableLink')</a>
    #end
  #end
#end
  
## render Blog
#if(("$!blogTitle" != '') && !$supressBlogTitle)
<h1 class="pageTitle">$blogTitle<!--iE6.0--></h1>
#end
<div class="cel_cm_blog_article" id="articles_start:$isarchive:$!{spacename}:">
#if(("$!renderArticlesMacro" == '') || !$xwiki.exists($renderArticlesMacro))
  #set($renderArticlesMacro = 'celMacros/renderBlogArticles.vm')
  #parse('celMacros/renderBlogArticles.vm')
#else
   $xwiki.includeForm("$renderArticlesMacro", false)
#end
</div> <!-- articles_start -->
##
#end
#end ## ##If-Modified-Since
